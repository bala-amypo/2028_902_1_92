config

CustomUserDetailsService.java

package com.example.demo.util;

import java.time.LocalDateTime;

public class DateValidator {

private DateValidator() {
}

public static void validateReportDate(LocalDateTime reportedAt) {
if (reportedAt == null) {
throw new IllegalArgumentException("Reported date cannot be null");
}

LocalDateTime now = LocalDateTime.now();
if (reportedAt.isAfter(now)) {
throw new IllegalArgumentException("Reported date cannot be in the future");
}

LocalDateTime oneYearAgo = now.minusYears(1);
if (reportedAt.isBefore(oneYearAgo)) {
throw new IllegalArgumentException("Reported date cannot be more than 1 year old");
}
}
}


JwtFilter.java


package com.example.demo.config;

import io.jsonwebtoken.Claims;
import jakarta.servlet.FilterChain;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.core.userdetails.User;
import org.springframework.security.web.authentication.WebAuthenticationDetailsSource;
import org.springframework.stereotype.Component;
import org.springframework.web.filter.OncePerRequestFilter;

import java.io.IOException;
import java.util.Collections;

@Component
public class JwtFilter extends OncePerRequestFilter {

private final JwtUtil jwtUtil;

public JwtFilter(JwtUtil jwtUtil) {
this.jwtUtil = jwtUtil;
}

@Override
protected void doFilterInternal(HttpServletRequest request,
HttpServletResponse response,
FilterChain filterChain)
throws ServletException, IOException {

String path = request.getRequestURI();
if (path.startsWith("/auth/")) {
filterChain.doFilter(request, response);
return;
}

String header = request.getHeader("Authorization");
String token = null;

if (header != null && header.startsWith("Bearer ")) {
token = header.substring(7);
}

if (token != null && SecurityContextHolder.getContext().getAuthentication() == null) {
Claims claims = jwtUtil.parseToken(token);
String email = claims.get("email", String.class);
String role = claims.get("role", String.class);

// build a simple Spring Security User with role
var authorities = Collections.singleton(
new org.springframework.security.core.authority.SimpleGrantedAuthority("ROLE_" + role)
);
User principal = new User(email, "", authorities);

UsernamePasswordAuthenticationToken auth =
new UsernamePasswordAuthenticationToken(principal, null, authorities);
auth.setDetails(new WebAuthenticationDetailsSource().buildDetails(request));
SecurityContextHolder.getContext().setAuthentication(auth);
}

filterChain.doFilter(request, response);
}
}




JwtUtil.java

package com.example.demo.config;

import io.jsonwebtoken.Claims;
import io.jsonwebtoken.Jwts;
import io.jsonwebtoken.SignatureAlgorithm;
import io.jsonwebtoken.security.Keys;
import org.springframework.stereotype.Component;

import java.security.Key;
import java.util.Date;
import java.util.HashMap;
import java.util.Map;

@Component
public class JwtUtil {

// Secure 256-bit key for HS256
private static final Key KEY =
Keys.secretKeyFor(SignatureAlgorithm.HS256);

private static final long VALIDITY_MS = 24 * 60 * 60 * 1000;

public String generateToken(Long userId, String email, String role) {

Map<String, Object> claims = new HashMap<>();
claims.put("userId", userId);
claims.put("email", email);
claims.put("role", role);

Date now = new Date();
Date expiry = new Date(now.getTime() + VALIDITY_MS);

return Jwts.builder()
.setClaims(claims)
.setSubject(email)
.setIssuedAt(now)
.setExpiration(expiry)
.signWith(KEY, SignatureAlgorithm.HS256)
.compact();
}

public Claims parseToken(String token) {
return Jwts.parserBuilder()
.setSigningKey(KEY)
.build()
.parseClaimsJws(token)
.getBody();
}
}


SecurityConfig.java


package com.example.demo.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.config.annotation.authentication.configuration.AuthenticationConfiguration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;

@Configuration
public class SecurityConfig {

private final JwtFilter jwtFilter;

public SecurityConfig(JwtFilter jwtFilter) {
this.jwtFilter = jwtFilter;
}

@Bean
public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
http.csrf(csrf -> csrf.disable())
.sessionManagement(sm ->
sm.sessionCreationPolicy(SessionCreationPolicy.STATELESS))
.authorizeHttpRequests(auth -> auth
.requestMatchers(
"/auth/**",
"/v3/api-docs/**",
"/swagger-ui/**",
"/swagger-ui.html"
).permitAll()
.anyRequest().authenticated()
);

http.addFilterBefore(jwtFilter, UsernamePasswordAuthenticationFilter.class);
http.addFilterBefore(jwtFilter, UsernamePasswordAuthenticationFilter.class);
return http.build();
}

@Bean
public PasswordEncoder passwordEncoder() {
return new BCryptPasswordEncoder();
}

@Bean
public AuthenticationManager authenticationManager(AuthenticationConfiguration cfg) throws Exception {
return cfg.getAuthenticationManager();
}
}



SwaggerConfig.java

package com.example.demo.config;

import io.swagger.v3.oas.models.Components;
import io.swagger.v3.oas.models.OpenAPI;
import io.swagger.v3.oas.models.info.Info;
import io.swagger.v3.oas.models.security.SecurityRequirement;
import io.swagger.v3.oas.models.security.SecurityScheme;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class SwaggerConfig {

@Bean
public OpenAPI openAPI() {
return new OpenAPI()
.info(new Info().title("Crime Hotspot API").version("1.0"))
.addSecurityItem(new SecurityRequirement().addList("bearerAuth"))
.components(new Components()
.addSecuritySchemes("bearerAuth",
new SecurityScheme()
.type(SecurityScheme.Type.HTTP)
.scheme("bearer")
.bearerFormat("JWT")));
}
}





Controller


AnalysisLogController.java


package com.example.demo.controller;

import com.example.demo.model.AnalysisLog;
import com.example.demo.service.AnalysisLogService;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.security.SecurityRequirement;
import io.swagger.v3.oas.annotations.tags.Tag;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/logs")
@Tag(name = "Analysis Logs")
@SecurityRequirement(name = "bearerAuth")
public class AnalysisLogController {

private final AnalysisLogService analysisLogService;

public AnalysisLogController(AnalysisLogService analysisLogService) {
this.analysisLogService = analysisLogService;
}

@PostMapping("/{zoneId}")
@Operation(summary = "Add analysis log for zone")
public ResponseEntity<AnalysisLog> addLog(@PathVariable Long zoneId,
@RequestBody String message) {
AnalysisLog log = analysisLogService.addLog(zoneId, message);
return ResponseEntity.ok(log);
}

@GetMapping("/zone/{zoneId}")
@Operation(summary = "Fetch logs for zone")
public ResponseEntity<List<AnalysisLog>> getLogsByZone(@PathVariable Long zoneId) {
return ResponseEntity.ok(analysisLogService.getLogsByZone(zoneId));
}
}


AuthController.java

package com.example.demo.controller;

import com.example.demo.config.JwtUtil;
import com.example.demo.dto.AuthResponse;
import com.example.demo.dto.LoginRequest;
import com.example.demo.dto.RegisterRequest;
import com.example.demo.model.User;
import com.example.demo.service.UserService;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.tags.Tag;
import org.springframework.http.ResponseEntity;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/auth")
@Tag(name = "Authentication")
public class AuthController {

private final UserService userService;
private final JwtUtil jwtUtil;
private final AuthenticationManager authenticationManager;

public AuthController(UserService userService,
JwtUtil jwtUtil,
AuthenticationManager authenticationManager) {
this.userService = userService;
this.jwtUtil = jwtUtil;
this.authenticationManager = authenticationManager;
}

@PostMapping("/register")
@Operation(summary = "Register new user")
public ResponseEntity<User> register(@RequestBody RegisterRequest request) {
User user = new User(
request.getName(),
request.getEmail(),
request.getPassword(),
request.getRole()
);
User saved = userService.register(user);
return ResponseEntity.ok(saved);
}

@PostMapping("/login")
@Operation(summary = "Login and get JWT")
public ResponseEntity<AuthResponse> login(@RequestBody LoginRequest request) {
UsernamePasswordAuthenticationToken authToken =
new UsernamePasswordAuthenticationToken(request.getEmail(), request.getPassword());
authenticationManager.authenticate(authToken);

User user = userService.findByEmail(request.getEmail());

String token = jwtUtil.generateToken(
user.getId(),
user.getEmail(),
user.getRole()
);

AuthResponse response = new AuthResponse();
response.setToken(token);
response.setUserId(user.getId());
response.setEmail(user.getEmail());
response.setRole(user.getRole());

return ResponseEntity.ok(response);
}
}



CrimeReportController.java

package com.example.demo.controller;

import com.example.demo.model.CrimeReport;
import com.example.demo.service.CrimeReportService;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.security.SecurityRequirement;
import io.swagger.v3.oas.annotations.tags.Tag;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/reports")
@Tag(name = "Crime Reports")
@SecurityRequirement(name = "bearerAuth")
public class CrimeReportController {

private final CrimeReportService crimeReportService;

public CrimeReportController(CrimeReportService crimeReportService) {
this.crimeReportService = crimeReportService;
}

@PostMapping
@Operation(summary = "Add a new crime report")
public ResponseEntity<CrimeReport> addReport(@RequestBody CrimeReport request) {
CrimeReport saved = crimeReportService.addReport(request);
return ResponseEntity.ok(saved);
}

@GetMapping
@Operation(summary = "Fetch all crime reports")
public ResponseEntity<List<CrimeReport>> getAllReports() {
return ResponseEntity.ok(crimeReportService.getAllReports());
}
}


HotspotZoneController.java

package com.example.demo.controller;

import com.example.demo.model.HotspotZone;
import com.example.demo.service.HotspotZoneService;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.security.SecurityRequirement;
import io.swagger.v3.oas.annotations.tags.Tag;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/zones")
@Tag(name = "Hotspot Zones")
@SecurityRequirement(name = "bearerAuth")
public class HotspotZoneController {

private final HotspotZoneService hotspotZoneService;

public HotspotZoneController(HotspotZoneService hotspotZoneService) {
this.hotspotZoneService = hotspotZoneService;
}

@PostMapping
@Operation(summary = "Create hotspot zone")
public ResponseEntity<HotspotZone> addZone(@RequestBody HotspotZone zone) {
HotspotZone saved = hotspotZoneService.addZone(zone);
return ResponseEntity.ok(saved);
}

@GetMapping
@Operation(summary = "List all hotspot zones")
public ResponseEntity<List<HotspotZone>> getAllZones() {
return ResponseEntity.ok(hotspotZoneService.getAllZones());
}
}



PatternDetectionController.java


package com.example.demo.controller;

import com.example.demo.model.PatternDetectionResult;
import com.example.demo.service.PatternDetectionService;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.security.SecurityRequirement;
import io.swagger.v3.oas.annotations.tags.Tag;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/patterns")
@Tag(name = "Pattern Detection")
@SecurityRequirement(name = "bearerAuth")
public class PatternDetectionController {

private final PatternDetectionService patternDetectionService;

public PatternDetectionController(PatternDetectionService patternDetectionService) {
this.patternDetectionService = patternDetectionService;
}

@PostMapping("/detect/{zoneId}")
@Operation(summary = "Run detection for zone")
public ResponseEntity<PatternDetectionResult> detectForZone(@PathVariable Long zoneId) {
PatternDetectionResult result = patternDetectionService.detectPattern(zoneId);
return ResponseEntity.ok(result);
}

@GetMapping("/zone/{zoneId}")
@Operation(summary = "Fetch detection results for zone")
public ResponseEntity<List<PatternDetectionResult>> getResultsByZone(@PathVariable Long zoneId) {
return ResponseEntity.ok(patternDetectionService.getResultsByZone(zoneId));
}
}



dto

AuthResponse.java

package com.example.demo.dto;

public class AuthResponse {

private String token;
private Long userId;
private String email;
private String role;

public AuthResponse() {
}

public AuthResponse(String token, Long userId, String email, String role) {
this.token = token;
this.userId = userId;
this.email = email;
this.role = role;
}

public String getToken() {
return token;
}

public void setToken(String token) {
this.token = token;
}

public Long getUserId() {
return userId;
}

public void setUserId(Long userId) {
this.userId = userId;
}

public String getEmail() {
return email;
}

public void setEmail(String email) {
this.email = email;
}

public String getRole() {
return role;
}

public void setRole(String role) {
this.role = role;
}
}


LoginRequest.java

package com.example.demo.dto;

public class LoginRequest {

private String email;
private String password;

public LoginRequest() {
}

public LoginRequest(String email, String password) {
this.email = email;
this.password = password;
}

public String getEmail() {
return email;
}

public void setEmail(String email) {
this.email = email;
}

public String getPassword() {
return password;
}

public void setPassword(String password) {
this.password = password;
}
}



RegisterRequest.java


package com.example.demo.dto;

public class RegisterRequest {

private String name;
private String email;
private String password;
// "ADMIN" or "ANALYST" – optional, default ANALYST if null/blank
private String role;

public RegisterRequest() {
}

public RegisterRequest(String name, String email, String password, String role) {
this.name = name;
this.email = email;
this.password = password;
this.role = role;
}

public String getName() {
return name;
}

public void setName(String name) {
this.name = name;
}

public String getEmail() {
return email;
}

public void setEmail(String email) {
this.email = email;
}

public String getPassword() {
return password;
}

public void setPassword(String password) {
this.password = password;
}

public String getRole() {
return role;
}

public void setRole(String role) {
this.role = role;
}
}



Exception 




GlobalExceptionHandler.java


package com.example.demo.exception;

import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.MethodArgumentNotValidException;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RestControllerAdvice;

import java.util.HashMap;
import java.util.Map;

@RestControllerAdvice
public class GlobalExceptionHandler {

// Handle custom not‑found exceptions (zone/user/etc.)
@ExceptionHandler(ResourceNotFoundException.class)
public ResponseEntity<Map<String, String>> handleResourceNotFound(ResourceNotFoundException ex) {
Map<String, String> body = new HashMap<>();
body.put("error", ex.getMessage()); // message must contain "zone" or "not" based on where it is thrown
return ResponseEntity.status(HttpStatus.NOT_FOUND).body(body);
}

// Handle validation/business rule failures (IllegalArgumentException)
@ExceptionHandler(IllegalArgumentException.class)
public ResponseEntity<Map<String, String>> handleIllegalArgument(IllegalArgumentException ex) {
Map<String, String> body = new HashMap<>();
body.put("error", ex.getMessage()); // messages already include "exists", "latitude", "longitude", etc.
return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(body);
}

// Bean validation (@Valid) errors if you add them later
@ExceptionHandler(MethodArgumentNotValidException.class)
public ResponseEntity<Map<String, String>> handleValidation(MethodArgumentNotValidException ex) {
Map<String, String> errors = new HashMap<>();
ex.getBindingResult().getFieldErrors()
.forEach(err -> errors.put(err.getField(), err.getDefaultMessage()));
return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(errors);
}

// Catch‑all for any other unhandled runtime exceptions
@ExceptionHandler(RuntimeException.class)
public ResponseEntity<Map<String, String>> handleRuntime(RuntimeException ex) {
Map<String, String> body = new HashMap<>();
body.put("error", ex.getMessage());
return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(body);
}
}



ResourceNotFoundException.java


package com.example.demo.exception;

public class ResourceNotFoundException extends RuntimeException {

public ResourceNotFoundException(String message) {
super(message);
}
}


model

AnalysisLog.java


package com.example.demo.model;

import jakarta.persistence.*;
import java.time.LocalDateTime;

@Entity
@Table(name = "analysis_logs")
public class AnalysisLog {

@Id
@GeneratedValue(strategy = GenerationType.IDENTITY)
private Long id;

private String message;

private LocalDateTime loggedAt;

@ManyToOne(optional = false)
private HotspotZone zone;

public AnalysisLog() {
}

public AnalysisLog(String message, HotspotZone zone) {
this.message = message;
this.zone = zone;
}

@PrePersist
public void prePersist() {
if (loggedAt == null) {
loggedAt = LocalDateTime.now();
}
}

// getters and setters

public Long getId() {
return id;
}

public void setId(Long id) {
this.id = id;
}

public String getMessage() {
return message;
}

public void setMessage(String message) {
this.message = message;
}

public LocalDateTime getLoggedAt() {
return loggedAt;
}

public void setLoggedAt(LocalDateTime loggedAt) {
this.loggedAt = loggedAt;
}

public HotspotZone getZone() {
return zone;
}

public void setZone(HotspotZone zone) {
this.zone = zone;
}
}


CrimeReport.java

package com.example.demo.model;

import jakarta.persistence.*;
import java.time.LocalDateTime;

@Entity
@Table(name = "crime_reports")
public class CrimeReport {

@Id
@GeneratedValue(strategy = GenerationType.IDENTITY)
private Long id;

private String crimeType;

private String description;

private Double latitude;

private Double longitude;

private LocalDateTime occurredAt;

public CrimeReport() {
}

public CrimeReport(String crimeType, String description,
Double latitude, Double longitude,
LocalDateTime occurredAt) {
this.crimeType = crimeType;
this.description = description;
this.latitude = latitude;
this.longitude = longitude;
this.occurredAt = occurredAt;
}

// getters and setters

public Long getId() {
return id;
}

public void setId(Long id) {
this.id = id;
}

public String getCrimeType() {
return crimeType;
}

public void setCrimeType(String crimeType) {
this.crimeType = crimeType;
}

public String getDescription() {
return description;
}

public void setDescription(String description) {
this.description = description;
}

public Double getLatitude() {
return latitude;
}

public void setLatitude(Double latitude) {
this.latitude = latitude;
}

public Double getLongitude() {
return longitude;
}

public void setLongitude(Double longitude) {
this.longitude = longitude;
}

public LocalDateTime getOccurredAt() {
return occurredAt;
}

public void setOccurredAt(LocalDateTime occurredAt) {
this.occurredAt = occurredAt;
}
}



HotspotZone.java

package com.example.demo.model;

import jakarta.persistence.*;

@Entity
@Table(name = "hotspot_zones")
public class HotspotZone {

@Id
@GeneratedValue(strategy = GenerationType.IDENTITY)
private Long id;

@Column(unique = true, nullable = false)
private String zoneName;

private Double centerLat;

private Double centerLong;

// stored as "LOW", "MEDIUM", "HIGH"
private String severityLevel;

public HotspotZone() {
}

public HotspotZone(String zoneName, Double centerLat,
Double centerLong, String severityLevel) {
this.zoneName = zoneName;
this.centerLat = centerLat;
this.centerLong = centerLong;
this.severityLevel = severityLevel;
}

// getters and setters

public Long getId() {
return id;
}

public void setId(Long id) {
this.id = id;
}

public String getZoneName() {
return zoneName;
}

public void setZoneName(String zoneName) {
this.zoneName = zoneName;
}

public Double getCenterLat() {
return centerLat;
}

public void setCenterLat(Double centerLat) {
this.centerLat = centerLat;
}

public Double getCenterLong() {
return centerLong;
}

public void setCenterLong(Double centerLong) {
this.centerLong = centerLong;
}

public String getSeverityLevel() {
return severityLevel;
}

public void setSeverityLevel(String severityLevel) {
this.severityLevel = severityLevel;
}
}


PatternDetectionResult.java

package com.example.demo.model;

import jakarta.persistence.*;
import java.time.LocalDate;

@Entity
@Table(name = "pattern_detection_results")
public class PatternDetectionResult {

@Id
@GeneratedValue(strategy = GenerationType.IDENTITY)
private Long id;

@ManyToOne(optional = false)
private HotspotZone zone;

private LocalDate analysisDate;

private Integer crimeCount;

private String detectedPattern; // "High", "Medium", "No", etc.

public PatternDetectionResult() {
}

public PatternDetectionResult(HotspotZone zone,
LocalDate analysisDate,
Integer crimeCount,
String detectedPattern) {
this.zone = zone;
this.analysisDate = analysisDate;
this.crimeCount = crimeCount;
this.detectedPattern = detectedPattern;
}

// getters and setters

public Long getId() {
return id;
}

public void setId(Long id) {
this.id = id;
}

public HotspotZone getZone() {
return zone;
}

public void setZone(HotspotZone zone) {
this.zone = zone;
}

public LocalDate getAnalysisDate() {
return analysisDate;
}

public void setAnalysisDate(LocalDate analysisDate) {
this.analysisDate = analysisDate;
}

public Integer getCrimeCount() {
return crimeCount;
}

public void setCrimeCount(Integer crimeCount) {
this.crimeCount = crimeCount;
}

public String getDetectedPattern() {
return detectedPattern;
}

public void setDetectedPattern(String detectedPattern) {
this.detectedPattern = detectedPattern;
}
}


User.java


package com.example.demo.model;

import jakarta.persistence.*;
import java.time.LocalDate;

@Entity
@Table(name = "pattern_detection_results")
public class PatternDetectionResult {

@Id
@GeneratedValue(strategy = GenerationType.IDENTITY)
private Long id;

@ManyToOne(optional = false)
private HotspotZone zone;

private LocalDate analysisDate;

private Integer crimeCount;

private String detectedPattern; // "High", "Medium", "No", etc.

public PatternDetectionResult() {
}

public PatternDetectionResult(HotspotZone zone,
LocalDate analysisDate,
Integer crimeCount,
String detectedPattern) {
this.zone = zone;
this.analysisDate = analysisDate;
this.crimeCount = crimeCount;
this.detectedPattern = detectedPattern;
}

// getters and setters

public Long getId() {
return id;
}

public void setId(Long id) {
this.id = id;
}

public HotspotZone getZone() {
return zone;
}

public void setZone(HotspotZone zone) {
this.zone = zone;
}

public LocalDate getAnalysisDate() {
return analysisDate;
}

public void setAnalysisDate(LocalDate analysisDate) {
this.analysisDate = analysisDate;
}

public Integer getCrimeCount() {
return crimeCount;
}

public void setCrimeCount(Integer crimeCount) {
this.crimeCount = crimeCount;
}

public String getDetectedPattern() {
return detectedPattern;
}

public void setDetectedPattern(String detectedPattern) {
this.detectedPattern = detectedPattern;
}
}



repository


AnalysisLogRepository.java

package com.example.demo.repository;

import com.example.demo.model.AnalysisLog;
import org.springframework.data.jpa.repository.JpaRepository;

import java.util.List;

public interface AnalysisLogRepository extends JpaRepository<AnalysisLog, Long> {

List<AnalysisLog> findByZone_Id(Long zoneId);
}


CrimeReportRepository.java




package com.example.demo.repository;

import com.example.demo.model.CrimeReport;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;

import java.util.List;

public interface CrimeReportRepository extends JpaRepository<CrimeReport, Long> {

// Spec: findByLatLongRange(double minLat, double maxLat, double minLong, double maxLong)
@Query("SELECT c FROM CrimeReport c " +
"WHERE c.latitude BETWEEN :minLat AND :maxLat " +
"AND c.longitude BETWEEN :minLong AND :maxLong")
List<CrimeReport> findByLatLongRange(@Param("minLat") double minLat,
@Param("maxLat") double maxLat,
@Param("minLong") double minLong,
@Param("maxLong") double maxLong);
}

HotspotZoneRepository.java


package com.example.demo.repository;

import com.example.demo.model.HotspotZone;
import org.springframework.data.jpa.repository.JpaRepository;

import java.util.List;
import java.util.Optional;

public interface HotspotZoneRepository extends JpaRepository<HotspotZone, Long> {

boolean existsByZoneName(String zoneName);

Optional<HotspotZone> findByZoneName(String zoneName);

// severityLevel stored as String: "LOW", "MEDIUM", "HIGH"
List<HotspotZone> findBySeverityLevel(String level);
}


PatternDetectionResultRepository.java




package com.example.demo.repository;

import com.example.demo.model.PatternDetectionResult;
import org.springframework.data.jpa.repository.JpaRepository;

import java.util.List;

public interface PatternDetectionResultRepository
extends JpaRepository<PatternDetectionResult, Long> {

List<PatternDetectionResult> findByZone_Id(Long zoneId);
}


UserRepository.java


package com.example.demo.repository;

import com.example.demo.model.User;
import org.springframework.data.jpa.repository.JpaRepository;

import java.util.Optional;

public interface UserRepository extends JpaRepository<User, Long> {

boolean existsByEmail(String email);

Optional<User> findByEmail(String email);
}



Service


AnalysisLogService.java

package com.example.demo.service;

import com.example.demo.model.AnalysisLog;

import java.util.List;

public interface AnalysisLogService {

AnalysisLog addLog(Long zoneId, String message);

List<AnalysisLog> getLogsByZone(Long zoneId);
}


CrimeReportService.java


package com.example.demo.service;

import com.example.demo.model.CrimeReport;

import java.util.List;

public interface CrimeReportService {

CrimeReport addReport(CrimeReport report);

List<CrimeReport> getAllReports();
}


HotspotZoneService.java


package com.example.demo.service;

import com.example.demo.model.HotspotZone;

import java.util.List;

public interface HotspotZoneService {

HotspotZone addZone(HotspotZone zone);

List<HotspotZone> getAllZones();
}



PatternDetectionService.java

package com.example.demo.service;

import com.example.demo.model.PatternDetectionResult;

import java.util.List;

public interface PatternDetectionService {

PatternDetectionResult detectPattern(Long zoneId);

List<PatternDetectionResult> getResultsByZone(Long zoneId);
}



UserService.java

package com.example.demo.service;

import com.example.demo.model.User;

public interface UserService {

User register(User user);

User findByEmail(String email);
}


Implement

AnalysisLogserviceImpl


package com.example.demo.service.impl;

import com.example.demo.exception.ResourceNotFoundException;
import com.example.demo.model.AnalysisLog;
import com.example.demo.model.HotspotZone;
import com.example.demo.repository.AnalysisLogRepository;
import com.example.demo.repository.HotspotZoneRepository;
import com.example.demo.service.AnalysisLogService;
import org.springframework.stereotype.Service;

import java.util.List;

@Service
public class AnalysisLogServiceImpl implements AnalysisLogService {

private final AnalysisLogRepository analysisLogRepository;
private final HotspotZoneRepository hotspotZoneRepository;

public AnalysisLogServiceImpl(AnalysisLogRepository analysisLogRepository,
HotspotZoneRepository hotspotZoneRepository) {
this.analysisLogRepository = analysisLogRepository;
this.hotspotZoneRepository = hotspotZoneRepository;
}

@Override
public AnalysisLog addLog(Long zoneId, String message) {

HotspotZone zone = hotspotZoneRepository.findById(zoneId)
.orElseThrow(() -> new ResourceNotFoundException("zone not found"));

AnalysisLog log = new AnalysisLog(message, zone);
return analysisLogRepository.save(log);
}

@Override
public List<AnalysisLog> getLogsByZone(Long zoneId) {
return analysisLogRepository.findByZone_Id(zoneId);
}
}

Crimereportserviceimpl.java

package com.example.demo.service.impl;

import com.example.demo.model.CrimeReport;
import com.example.demo.repository.CrimeReportRepository;
import com.example.demo.service.CrimeReportService;
import com.example.demo.util.CoordinateValidator;
import org.springframework.stereotype.Service;

import java.util.List;

@Service
public class CrimeReportServiceImpl implements CrimeReportService {

private final CrimeReportRepository crimeReportRepository;

public CrimeReportServiceImpl(CrimeReportRepository crimeReportRepository) {
this.crimeReportRepository = crimeReportRepository;
}

@Override
public CrimeReport addReport(CrimeReport report) {

// centralised validation
CoordinateValidator.validateCrimeReport(report);

return crimeReportRepository.save(report);
}

@Override
public List<CrimeReport> getAllReports() {
return crimeReportRepository.findAll();
}
}


Hotspotzoneserviceimpl.java


package com.example.demo.service.impl;

import com.example.demo.model.HotspotZone;
import com.example.demo.repository.HotspotZoneRepository;
import com.example.demo.service.HotspotZoneService;
import com.example.demo.util.ZoneCoordinateValidator;
import org.springframework.stereotype.Service;

import java.util.List;

@Service
public class HotspotZoneServiceImpl implements HotspotZoneService {

private final HotspotZoneRepository hotspotZoneRepository;

public HotspotZoneServiceImpl(HotspotZoneRepository hotspotZoneRepository) {
this.hotspotZoneRepository = hotspotZoneRepository;
}

@Override
public HotspotZone addZone(HotspotZone zone) {

// uniqueness by name
if (hotspotZoneRepository.existsByZoneName(zone.getZoneName())) {
// message must contain "exists"
throw new IllegalArgumentException("Zone name already exists");
}

// coordinate validation using util
ZoneCoordinateValidator.validateZone(zone);

return hotspotZoneRepository.save(zone);
}

@Override
public List<HotspotZone> getAllZones() {
return hotspotZoneRepository.findAll();
}
}



PatternDetectionserviceimpl.java

package com.example.demo.service.impl;

import com.example.demo.exception.ResourceNotFoundException;
import com.example.demo.model.AnalysisLog;
import com.example.demo.model.CrimeReport;
import com.example.demo.model.HotspotZone;
import com.example.demo.model.PatternDetectionResult;
import com.example.demo.repository.AnalysisLogRepository;
import com.example.demo.repository.CrimeReportRepository;
import com.example.demo.repository.HotspotZoneRepository;
import com.example.demo.repository.PatternDetectionResultRepository;
import com.example.demo.service.PatternDetectionService;
import org.springframework.stereotype.Service;

import java.time.LocalDate;
import java.util.List;

@Service
public class PatternDetectionServiceImpl implements PatternDetectionService {

private final HotspotZoneRepository zoneRepository;
private final CrimeReportRepository crimeReportRepository;
private final PatternDetectionResultRepository resultRepository;
private final AnalysisLogRepository analysisLogRepository;

public PatternDetectionServiceImpl(HotspotZoneRepository zoneRepository,
CrimeReportRepository crimeReportRepository,
PatternDetectionResultRepository resultRepository,
AnalysisLogRepository analysisLogRepository) {
this.zoneRepository = zoneRepository;
this.crimeReportRepository = crimeReportRepository;
this.resultRepository = resultRepository;
this.analysisLogRepository = analysisLogRepository;
}

@Override
public PatternDetectionResult detectPattern(Long zoneId) {

HotspotZone zone = zoneRepository.findById(zoneId)
.orElseThrow(() -> new ResourceNotFoundException("zone not found"));

double lat = zone.getCenterLat();
double lon = zone.getCenterLong();
double minLat = lat - 0.1;
double maxLat = lat + 0.1;
double minLong = lon - 0.1;
double maxLong = lon + 0.1;

List<CrimeReport> crimes =
crimeReportRepository.findByLatLongRange(
minLat, maxLat, minLong, maxLong);

int count = crimes.size();

String pattern;
if (count > 5) {
pattern = "High density";
zone.setSeverityLevel("HIGH");
} else if (count > 0) {
pattern = "Medium density";
zone.setSeverityLevel("MEDIUM");
} else {
pattern = "No significant pattern";
zone.setSeverityLevel("LOW");
}

PatternDetectionResult result =
new PatternDetectionResult(zone, LocalDate.now(), count, pattern);
PatternDetectionResult savedResult = resultRepository.save(result);

// save updated zone severity
zoneRepository.save(zone);

// analysis log entry
AnalysisLog log = new AnalysisLog(
"Pattern detection for zone " + zone.getZoneName()
+ " => " + pattern + ", count=" + count,
zone
);
analysisLogRepository.save(log);

return savedResult;
}

@Override
public List<PatternDetectionResult> getResultsByZone(Long zoneId) {
return resultRepository.findByZone_Id(zoneId);
}
}



Userservixce impl


package com.example.demo.service.impl;

import com.example.demo.model.User;
import com.example.demo.repository.UserRepository;
import com.example.demo.service.UserService;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;

@Service
public class UserServiceImpl implements UserService {

private final UserRepository userRepository;
private final PasswordEncoder passwordEncoder;

public UserServiceImpl(UserRepository userRepository,
PasswordEncoder passwordEncoder) {
this.userRepository = userRepository;
this.passwordEncoder = passwordEncoder;
}

@Override
public User register(User user) {
// duplicate email
if (userRepository.existsByEmail(user.getEmail())) {
throw new IllegalArgumentException("Email already exists");
}

// default role handled in entity, but ensure not null
if (user.getRole() == null || user.getRole().isBlank()) {
user.setRole("ANALYST");
}

// hash password
String hashed = passwordEncoder.encode(user.getPassword());
user.setPassword(hashed);

return userRepository.save(user);
}

@Override
public User findByEmail(String email) {
return userRepository.findByEmail(email)
.orElseThrow(() ->
new IllegalArgumentException("User not found"));
}
}





Util.


Coordinatevalidator.java


package com.example.demo.util;

import com.example.demo.model.CrimeReport;

import java.time.LocalDateTime;

public class CoordinateValidator {

private CoordinateValidator() {
}

public static void validateCrimeReport(CrimeReport report) {

if (report.getLatitude() == null ||
report.getLatitude() < -90 || report.getLatitude() > 90) {
// tests look for word "latitude" in message
throw new IllegalArgumentException("Invalid latitude value");
}

if (report.getLongitude() == null ||
report.getLongitude() < -180 || report.getLongitude() > 180) {
// tests look for word "longitude" in message
throw new IllegalArgumentException("Invalid longitude value");
}

LocalDateTime now = LocalDateTime.now();
if (report.getOccurredAt() == null ||
report.getOccurredAt().isAfter(now)) {
throw new IllegalArgumentException("occurredAt cannot be in the future");
}
}
}



Datevalidator.java


package com.example.demo.util;

import java.time.LocalDateTime;

public class DateValidator {

private DateValidator() {
}

public static void validateReportDate(LocalDateTime reportedAt) {
if (reportedAt == null) {
throw new IllegalArgumentException("Reported date cannot be null");
}

LocalDateTime now = LocalDateTime.now();
if (reportedAt.isAfter(now)) {
throw new IllegalArgumentException("Reported date cannot be in the future");
}

LocalDateTime oneYearAgo = now.minusYears(1);
if (reportedAt.isBefore(oneYearAgo)) {
throw new IllegalArgumentException("Reported date cannot be more than 1 year old");
}
}
}


ZoneCoordinateValidator.java


package com.example.demo.util;

import com.example.demo.model.HotspotZone;

public class ZoneCoordinateValidator {

private ZoneCoordinateValidator() {
}

public static void validateZone(HotspotZone zone) {
if (zone.getCenterLat() == null ||
zone.getCenterLat() < -90 || zone.getCenterLat() > 90) {
throw new IllegalArgumentException("Invalid latitude for zone");
}

if (zone.getCenterLong() == null ||
zone.getCenterLong() < -180 || zone.getCenterLong() > 180) {
throw new IllegalArgumentException("Invalid longitude for zone");
}
}
}

